<?php
// scripts/generate_sample_results.php
// Generates a comprehensive sample_results.sql with stream-aware logic and passing rules (Avg > 1.5)
require_once __DIR__ . '/../config/database.php';

$output = "-- sql/sample_results.sql\n";
$output .= "-- Generated by scripts/generate_sample_results.php\n\n";
$output .= "SET FOREIGN_KEY_CHECKS = 0;\n";
$output .= "DELETE FROM results;\n";
$output .= "SET FOREIGN_KEY_CHECKS = 1;\n\n";

// Helper for grade and point
function getGrade($marks) {
    if ($marks >= 90) return ['A+', 4.0];
    if ($marks >= 85) return ['A', 3.7];
    if ($marks >= 80) return ['A-', 3.5];
    if ($marks >= 75) return ['B+', 3.3];
    if ($marks >= 70) return ['B', 3.0];
    if ($marks >= 65) return ['B-', 2.7];
    if ($marks >= 60) return ['C+', 2.3];
    if ($marks >= 55) return ['C', 2.0];
    if ($marks >= 50) return ['C-', 1.7];
    if ($marks >= 45) return ['D+', 1.3];
    if ($marks >= 40) return ['D', 1.0];
    return ['F', 0.0];
}

$conn = getDBConnection();

// Get all subjects
$subjects = [];
$res = $conn->query("SELECT * FROM subjects");
while($row = $res->fetch_assoc()) {
    $subjects[$row['class_level']][] = $row;
}

// Get all students
$students = [];
$res = $conn->query("SELECT * FROM students");
while($row = $res->fetch_assoc()) {
    $students[] = $row;
}

// Academic Year Mapping (Extend to 5 years for full history Grade 5 -> Form 4)
$years = ['2020/2021', '2021/2022', '2022/2023', '2023/2024', '2024/2025'];

// Order of progression
$progression = [
    'Grade 5' => 1,
    'Grade 6' => 2,
    'Grade 7' => 3,
    'Grade 8' => 4,
    'Form 1' => 5,
    'Form 2' => 6,
    'Form 3' => 7,
    'Form 4' => 8,
    'Graduated' => 9
];
$inverted_progression = array_flip($progression);

foreach ($students as $student) {
    $current_level = $student['class_level'];
    if (!isset($progression[$current_level])) continue;
    
    $is_retained = (strpos($student['reg_no'], 'SRM2408') === 0);
    $target_level_idx = $progression[$current_level];
    
    // Generate history
    $start_idx = 1;
    // Include current level for all students to ensure they have current results
    $end_idx = ($current_level === 'Graduated') ? 8 : $target_level_idx;
    
    // Assign stream for Form 3/4 if missing (User requirement: 4 Science, 3 General, 3 Arts for F4)
    if (($current_level === 'Form 3' || $current_level === 'Form 4') && empty($student['stream'])) {
        static $f4_science = 0;
        static $f4_general = 0;
        static $f4_arts = 0;
        
        if ($f4_science < 4) { $s = 'Science'; $f4_science++; }
        elseif ($f4_general < 3) { $s = 'General'; $f4_general++; }
        else { $s = 'Arts'; $f4_arts++; }
        
        $conn->query("UPDATE students SET stream = '$s' WHERE id = " . $student['id']);
        $student['stream'] = $s; // Update local copy
    }
    
    for ($i = $start_idx; $i <= $end_idx; $i++) {
        $level_name = $inverted_progression[$i];
        if (!isset($subjects[$level_name])) continue;
        
        // Year logic: Map level to academic year relative to current level
        $year_offset = 4 - ($target_level_idx - $i);
        if ($year_offset < 0) $year_offset = 0;
        $academic_year = $years[$year_offset];
        
        // Filter subjects by stream for Form 3/4
        $available_subjects = [];
        foreach ($subjects[$level_name] as $sub) {
            if ($i < 7) { // Below Form 3
                $available_subjects[] = $sub;
            } else { // Form 3/4
                if ($sub['stream'] === 'Core' || empty($student['stream']) || strpos($sub['stream'], $student['stream']) !== false) {
                    $available_subjects[] = $sub;
                }
            }
        }
        
        foreach ([1, 2] as $term) {
            $is_failing_year = ($is_retained && $i === $target_level_idx && $academic_year === '2023/2024');
            $term_sql = "INSERT INTO results (student_id, subject_id, marks_obtained, grade, grade_point, exam_date, term, academic_year) VALUES ";
            $values = [];
            
            foreach ($available_subjects as $sub) {
                if ($is_failing_year) {
                    $marks = 30 + (($student['id'] + $sub['id'] + $term) % 20);
                } else {
                    $marks = 55 + (($student['id'] + $sub['id'] + $term) % 40);
                }
                
                list($grade, $gp) = getGrade($marks);
                $year_part = explode('/', $academic_year)[0];
                $exam_date = ($term == 1) ? "$year_part-03-15" : ($year_part + 1) . "-06-20";
                
                $values[] = "({$student['id']}, {$sub['id']}, {$marks}, '{$grade}', {$gp}, '{$exam_date}', {$term}, '{$academic_year}')";
            }
            
            if (!empty($values)) {
                $output .= $term_sql . implode(", ", $values) . ";\n";
            }
        }
    }
}

file_put_contents(__DIR__ . '/../sql/sample_results.sql', $output);
echo "New sample_results.sql generated efficiently with current level data and Form 4 distribution!\n";
?>
